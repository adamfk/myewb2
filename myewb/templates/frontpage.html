{% extends "topics/base.html" %}

{% load i18n %}
{% load uni_form %}
{% load pagination_tags %}
{% load group_tags %}
{% load tagging_tags %}
{% load events_tags %}
{% load cache %}

{% block extra_head %}
    {{ block.super }}
    
    <link rel="alternate" type="application/rss+xml" title="myEWB Front Page" href="{% url topic_feed_all %}" />
	<link rel="stylesheet" href="{{ STATIC_URL }}css/toolbars.css" />   
	
	
	
	
	
	{# JS here for the frontpage ajax updates #}
<script type="text/javascript">
// Frontpage Ajax updates

	var currentURL = "";

	function load_posts(url)
	{
		  currentURL = url
		  $('#topiclisting').hide();
		  $('.frontpage-loading').show();
			
		  $('#topiclisting').load(url,
			function() {
      		  $('.frontpage-loading').hide();
			  $('#topiclisting').show();

			  $('.pagination a').click(function() {
				  if (currentURL.indexOf('?') != -1)
					  currentURL = currentURL.substring(0, currentURL.indexOf('?'));
				  load_posts(currentURL + $(this).attr('href'));
				  return false;
	  		  });

		    }
		  );				  
	}
	
	$(document).ready(function() {
		$('.frontpage-update').click(function() {
		
		  $('.frontpage-mygroups-actions').hide();
		  $('.frontpage-mygroups-actions').parent().removeClass('bkgd-light');
			  
		  $(this).parent().addClass('bkgd-light');
		  $(this).siblings('.frontpage-mygroups-actions').show();

		    // do stuff
		    var groupSlug = $(this).attr("id").substring(17);

		    load_posts('/groups/' + groupSlug + '/posts/');
		  
		  $('.frontpage-reset').show();
		  
		  {# @@@ this should be updated at some point in time. #}
		  
			return false;
		});
		
		
		$('.frontpage-reset').click(function() {

		  $('.frontpage-mygroups-actions').hide();
		  $('.frontpage-mygroups-actions').parent().removeClass('bkgd-light');
			  
		  load_posts('{{request.url}}');
		  $('.frontpage-reset').hide();
		  
		  return false;
        });
		
		load_posts('{{request.url}}');

	});
 
 </script>
 
 
{% endblock %}

{% block frontpagerightJS %}
            function toggleFrontpageToolbar() {
                $('#toolbarcolumn_right_container').toggle();
                $('#toolbarcolumn_right_show').toggle();
                
                {% if user.is_authenticated %}
                    
                    var action = "";
                    if (! $('#toolbarcolumn_right_container').is(':visible'))
                        action = "close";
                    else
                        action = "show";
                    
                    
                    $.ajax({
                      url: "{% url profile_toolbar_action %}" + action + "/" + "toolbarcolumn_right_container" + "/",
                      cache: false,  // this prepends another query onto the end with a timestamp - make sure it doesn't mix up the handler page?
                    });
                {% endif %}
                {# state saving only works if youre logged in, so only really try then #}

                                

            }
            
            $('.frontpagetoolbarToggles').click(function(){	
                toggleFrontpageToolbar();

          	  });

{% endblock %}


{% block head_title %}{% trans "Discussion Board" %}{% endblock %}

{% block body %}

	<div class="frontpage-loading">Loading...</div>     
 
 	<div id="topiclisting">
 		{% comment %}
		{% ifequal mode "newposts" %}
			<h2>{% trans "New posts since last sign-in" %}</h2>
		{% endifequal %}

		{% ifequal mode "newreplies" %}
			<h2>{% trans "New replies since last sign-in" %}</h2>
		{% endifequal %}

		{% ifequal mode "featured" %}
			<h2>{% trans "Featured Posts" %}</h2>
		{% endifequal %}

	    {% autopaginate topics 10 %}
    
	    {% for topic in topics %}
        	{% include "topics/topic_item.html" %}
    	{% endfor %}
    
    	{% paginate %}
    	{% endcomment %}
    </div>
            
{% endblock %}

{% block toolbar_left %}
    {% if user.is_authenticated %}
        <div class="toolbarheader bkgd" id="box-latestactivity">{% trans "Latest Activity" %}</div>
        <div class="toolbarcontent">
        	Since you last signed in {{ user.get_profile.previous_login|timesince}} ago:
        	<div class="latest-activity-stats">
        	
        	{% if posts_since_login %}
				<a href="{% url topic_since_login %}">
				{% ifequal posts_since_login 1 %}
					1 new post
				{% else %}
					{{posts_since_login}} new posts
				{% endifequal %}
				</a>
			{% else %}
				no new posts
			{% endif %}
			<br/>
			
        	{% if replies_since_login %}
				<a href="{% url topic_replies_since_login %}">
				{% ifequal replies_since_login 1 %}
					1 post with new replies
				{% else %}
					{{replies_since_login}} posts with new replies
				{% endifequal %}
				</a>
			{% else %}
				no new replies
			{% endif %}
			</div>

            {% if can_adminovision %}
                <p style="margin-bottom: 0; text-align: right;">
                    {% spaceless %}
                        <a href="{% url topic_adminovision %}">
                            {% if adminovision %}
                    			Turn off adminovision
                    		{% else %}
                    			Turn on adminovision
                    		{% endif %}
                    	</a>
                    {% endspaceless %}
                </p>
           	{% else %}
               	{% if can_execovision %}
                <p style="margin-bottom: 0; text-align: right;">
               		{% spaceless %}
               			<a href="{% url topic_adminovision %}">
                		{% if adminovision %}
                			Turn off execovision
                		{% else %}
                			Turn on execovision
                		{% endif %}
                		</a>
                	{% endspaceless %}
                	</p>
                {% endif %}
           	{% endif %}
        </div>
        
		{% ifnotequal mode "newposts" %}
			{% ifnotequal mode "newreplies" %}
				{% ifnotequal mode "featured" %}
        {# my groups #}
        <div class="toolbarheader bkgd" id="box-frontpage-mygroups">{% trans "My groups" %}</div>
        <div class="toolbarcontent">
        
				<a href="#" class="frontpage-reset" style="display:none;">Show all posts (reset page)</a>
        
             	{% for group in user.get_networks %}
	                <div class="frontpage-mygroups-div"><a href="#" class="frontpage-update" id="frontpage-update-{{ group.slug }}">{{ group.name }}</a>
	                <div class="frontpage-mygroups-actions">x new posts<br/><a href="{% groupurl topic_new group %}">New post &raquo;</a><br/><a href="{% url group_detail group.slug %}">View group info &raquo;</a></div></div>
            	{% endfor %}
            	
            	
            	{# these should be combined, and sorted by # of new posts. #}
            	
            	
            	{% for group in user.get_communities %}
<div class="frontpage-mygroups-div"><a href="#" class="frontpage-update" id="frontpage-update-{{ group.slug }}">{{ group.name }}</a><br/>
	                <div class="frontpage-mygroups-actions">x new posts<br/><a href="{% groupurl topic_new group %}">New post &raquo;</a><br/><a href="{% url group_detail group.slug %}">View group info &raquo;</a></div></div>

            	{% endfor %}
        </div>
        {# such a hack.  i am embarrassed. #}
        {% else %}
        	<a href="#" class="frontpage-reset" style="display:none;">Show all posts (reset page)</a>
        {% endifnotequal %}
        {% else %}
        	<a href="#" class="frontpage-reset" style="display:none;">Show all posts (reset page)</a>
        {% endifnotequal %}
        {% else %}
        	<a href="#" class="frontpage-reset" style="display:none;">Show all posts (reset page)</a>
        {% endifnotequal %}
        
        
    {% else %}
        <div class="toolbarheader bkgd">{% trans "Sign In" %}</div>
        <div class="toolbarcontent">
            <form class="toolbarlogin" method="POST" action="{% url acct_login %}">
                {% for field in login_form %}
                    <div style="padding-bottom: 7px;">
                        {{ field.label_tag }} &nbsp;&nbsp;&nbsp;
                        {{ field }}
                    </div>
                {% endfor %}
                <div style="text-align: center;">
                    <input type="submit" value="{% trans "sign in" %} &raquo;" /><br/>
                    <a href="{% url acct_passwd_reset %}">{% trans "Forgot password?" %}</a>
                </div>
            </form>
        </div>
       	<a href="#" class="frontpage-reset" style="display:none;">Show all posts (reset page)</a>
    {% endif %}
            
    <div class="toolbarheader bkgd"  id="box-happening">{% trans "Happening in EWB" %}</div>
    <div class="toolbarcontent" style="padding: 2px; overflow: none;">
        {% events_widget user %}
        <div style="text-align: right;">
            <a href="{% url events_all %}">{% trans "more events" %} &raquo;</a>
        </div>
    </div>
    
    <div class="toolbarheader bkgd" id="box-online">{% trans "Who's Online" %}</div>
    <div class="toolbarcontent">
        {% for online in online_users %}
            <a href="{% url profile_detail online %}">{{ online.visible_name }}</a><br/>
        {% endfor %} <br/>
        and {{ online_anon }} guests
    </div>
{% endblock %}

{% block toolbar_right %}
    {# put this in its own file, since its so big (and others like kyle may want to edit it #}
    {% include "frontpage-right.html" %}
{% endblock %}      

{% block toolbarcolumn_right_top %}
            <div id="toolbarcolumn_right_container">


                <div id="box-around-ewb-rightbar" class="toolbarheader-wide bkgd frontpagetoolbarToggles">Around EWB</div>
{% endblock %}

{% block toolbarcolumn_right_bottom %}
</div>


<div id="toolbarcolumn_right_show" class="blue frontpagetoolbarToggles" style="display:none;">
            +
            </div>

{% endblock %}      

{% block extra_body %}
{% comment %}
    <script type="text/javascript">
      // from http://stackoverflow.com/questions/619773/filter-out-replies-in-a-twitter-feed
      function filterCallback( twitter_json ) {
        var result = [];
        for(var index in twitter_json) {
          if(twitter_json[index].in_reply_to_user_id == null) {
            result[result.length] = twitter_json[index];
          }
          if( result.length==4 ) break; // Edit this to change the maximum tweets shown
        }
        twitterCallback2(result); // Pass tweets onto the original callback. Don't change it!
      }
    </script>
    <script type="text/javascript" src="http://twitter.com/javascripts/blogger.js"></script>
    <script type="text/javascript" src="http://twitter.com/statuses/user_timeline/ewb.json?callback=filterCallback&amp;count=10"></script>
{% endcomment %}
{% endblock %}
