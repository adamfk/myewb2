{% extends "volunteering/base.html" %}

{% load boolean_icon %}

{% block head_title %}
Volunteering » Sessions » {{ session.name }}
{% endblock %}

{% block body %}
<style>
.editlink {
font-size: 10px;
font-weight: normal;
margin-left: 10px;
}
.htmlbox {
display: none;
margin-left: 25px;
border: 1px solid;
background: #f0f0f0;
padding: 10px;
}
.ui-icon-arrowthick-2-n-s {
float: left;
cursor: pointer;
}
.question, .criteria {
margin: 5px;
padding: 5px;
border: 1px solid;
background: #ffffff;
}
</style>

<h2>{{session.name}}</h2>

<p>
    <a href="#">X applications</a>
</p>

<div id="session-tabs">
	<ul>
		<li><a href="#logistics">Logistics</a></li>
		<li><a href="#questions">Questions</a></li>
		<li><a href="#criteria">Criteria</a></li>
	</ul>
	
	<div id="logistics">
        <h2>
            Logistics
            <a href="{% url session_edit session.id %}" class="editlink">(edit)</a>
        </h2>

        <p>Open: {{session.open_date}}<br/>
        Close: {{session.close_date}}<br/>
        Due: {{session.due_date}}<br/>
        Email sent: {{ session.email_sent|boolean_icon}}</p>

        <a href="#" id="session_display_all">show all details</a> | 
        <a href="#" id="session_hide_all">hide all details</a> 
        <hr/>
        
	    <h3><a href="#" class="session_toggle" id="eninstruc_toggle">English instructions</a></h3>
	    <div id="eninstruc" class="htmlbox">
	        {{session.en_instructions|safe}}
	    </div>

	    <h3><a href="#" class="session_toggle" id="frinstruc_toggle">French instructions</a></h3>
	    <div id="frinstruc" class="htmlbox">
	        {{session.fr_instructions|safe}}
	    </div>

	    <h3><a href="#" class="session_toggle" id="closeemail_toggle">Close email</a></h3>
	    <div id="closeemail" class="htmlbox">
	        {{session.close_email|safe}}
	    </div>

	    <h3><a href="#" class="session_toggle" id="rejemail_toggle">Rejection email</a></h3>
	    <div id="rejemail" class="htmlbox">
	        {{session.rejection_email|safe}}
	    </div>

	    <h3><a href="#" class="session_toggle" id="comemail_toggle">Completed application email</a></h3>
	    <div id="comemail" class="htmlbox">
	        {{session.completed_application|safe}}
	    </div>
    </div>

    <div id="questions">
        <h2>Questions</h2>

	    <p>
	        <a href="{% url question_new session.id %}" id="add_question">add a question</a>
	    </p>

        <div id="sortable-questions">
	    {% for q in session.question_set.all %}
	        <p class="question" id="question-{{q.id}}">
	            <span class="ui-icon ui-icon-arrowthick-2-n-s"></span>
        	    {{ q.question }}<br/>
        	    &nbsp;&nbsp;&nbsp;&nbsp;
        	    <a href="{% url question_edit q.id %}" class="question_edit">(edit)</a>
        	    <a href="#" class="question_delete" id="question-delete-{{q.id}}">(delete)</a>
            </p>
	        
	    {% endfor %}
	    </div>
    </div>

    <div id="criteria">
        <h2>Criteria</h2>
    
	    <p>
	        <a href="{% url criteria_new session.id %}" id="add_criteria">add a criteria</a>
	    </p>

        <div id="sortable-criteria">
	    {% for c in session.evaluationcriterion_set.all %}
	        <p class="criteria" id="criteria-{{c.id}}">
	            <span class="ui-icon ui-icon-arrowthick-2-n-s"></span>
        	    {{ c.criteria }} ({{c.column_header}})<br/>
        	    &nbsp;&nbsp;&nbsp;&nbsp;
        	    <a href="{% url criteria_edit c.id %}" class="criteria_edit">(edit)</a>
        	    <a href="#" class="criteria_delete" id="criteria-delete-{{c.id}}">(delete)</a>
            </p>
	        
	    {% endfor %}
	    </div>
    </div>
</div>

<a href="{% url sessions %}">Back to session list</a>

<div id="dialog" title="Edit">
    <div id="dialog-contents">
	</div>
</div>

{% endblock %}

{% block extra_body %}
<script type="text/javascript">
	$().ready(function() {
		$("#session-tabs").tabs({
			show: function(event, ui) {
				parent.location.hash = ui.panel.id;
			}
		});

		$('#session_display_all').click(function() {
			$('div.htmlbox').slideDown();
			return false;
		});
		$('#session_hide_all').click(function() {
			$('div.htmlbox').slideUp();
			return false;
		});

		$('a.session_toggle').click(function() {
			var divname = $(this).attr('id').replace('_toggle', '');
			$('div#' + divname).slideToggle();
			return false;
		});

        var submit_url = "";
        function add_question_callback() {
            $('#dialog form').submit(function() {
    		    $('#dialog-contents').html("saving...");
                $.post(submit_url,
                    $(this).serialize(),
                    function(data) {
                        if (data == "success")
                        {
                            // TODO: js-add this to the question list and close the dialog,
                            // instead of reloading the entire page.
                            //$('#dialog').dialog('close');
                            
                            window.location.reload();
                        }
                        else
                        {
                            $('#dialog-contents').html(data);
                            add_question_callback();
                        }
                    });
                return false;
            });
    	}
		
		$('a#add_question').click(function() {
		    $('#dialog').attr('title', 'New Question');
		    $('#dialog-contents').html("loading...");
    		$("#dialog").dialog({ modal: true,width: 460});
    		$("#dialog").dialog('open');
		    
            submit_url = '{% url question_new session.id %}';
		    $('#dialog-contents').load($(this).attr('href'),
		                                add_question_callback);
    	    return false;
		});
		
		$('a.question_edit').click(function() {
            $('#dialog').attr('title', 'Edit Question');
            $('#dialog-contents').html("loading...");
            $('#dialog').dialog({model: true, width: 460});
            $('#dialog').dialog('open');
            
            submit_url = $(this).attr('href');
            $('#dialog-contents').load($(this).attr('href'),
                                        add_question_callback);
		    return false;
		});
		
		$('a.question_delete').click(function() {
		    var confirmed = confirm("Are you sure you want to delete this question? Any associated answers will also be deleted!");
		    if (confirmed)
		    {
	            var q_id = $(this).attr('id').substr(16);
                $.post('{% url question_delete %}',
                    {'question_id': q_id});
                // TODO: js-ize this instead of reloading entire page?
                window.location.reload();
		    }
		    return false;
		});

	    $('#sortable-questions').sortable({
	        revert: true,
	        handle: 'span',
	        tolerance: 'pointer',
	        update: function(event, ui) {
	            var q_id = ui.item.attr('id').substr(9);
	            var new_pos = ui.item.parent().children().index(ui.item) + 1;
                $.post('{% url question_reorder %}',
                    {'question_id': q_id,
                     'new_order': new_pos});
	        }
	    });
	    
		$('a#add_criteria').click(function() {
		    $('#dialog').attr('title', 'New Criteria');
		    $('#dialog-contents').html("loading...");
    		$("#dialog").dialog({ modal: true,width: 460});
    		$("#dialog").dialog('open');
		    
            submit_url = '{% url criteria_new session.id %}';
		    $('#dialog-contents').load($(this).attr('href'),
		                                add_question_callback);
    	    return false;
		});
		
		$('a.criteria_edit').click(function() {
            $('#dialog').attr('title', 'Edit Criteria');
            $('#dialog-contents').html("loading...");
            $('#dialog').dialog({model: true, width: 460});
            $('#dialog').dialog('open');
            
            submit_url = $(this).attr('href');
            $('#dialog-contents').load($(this).attr('href'),
                                        add_question_callback);
		    return false;
		});
		
		$('a.criteria_delete').click(function() {
		    var confirmed = confirm("Are you sure you want to delete this criteria? Any associated rankings will also be deleted!");
		    if (confirmed)
		    {
	            var q_id = $(this).attr('id').substr(16);
                $.post('{% url criteria_delete %}',
                    {'criteria_id': q_id});
                // TODO: js-ize this instead of reloading entire page?
                window.location.reload();
		    }
		    return false;
		});

	    $('#sortable-criteria').sortable({
	        revert: true,
	        handle: 'span',
	        tolerance: 'pointer',
	        update: function(event, ui) {
	            var q_id = ui.item.attr('id').substr(9);
	            var new_pos = ui.item.parent().children().index(ui.item) + 1;
                $.post('{% url criteria_reorder %}',
                    {'criteria_id': q_id,
                     'new_order': new_pos});
	        }
	    });
	});
</script>
{% endblock %}
