{% extends "volunteering/base.html" %}

{% load avatar_tags %}

{% block head_title %}
Volunteering Â» Evaluations
{% endblock %}

{% block body %}
<style>
select {
    display: inline;
}
#submit_link {
    color: red;
    margin-left: 25px;
}
table#evaluations {
    border: 0px;
    width: 100%;
}
table#evaluations td {
    vertical-align: top;
}
div.eval {
    width: 40%;
    float: right;
}
div.eval textarea {
    width: 100%;
    margin-bottom: 3px;
}
hr.clear {
    clear: both;
}
div.leftpanel {
    width: 55%;
}
.htmlbox {
    margin-left: 25px;
    border: 1px solid;
    padding: 10px;
/*    background: #f0f0f0;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px; */
}
.inputbox {
    border: 0px;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
    margin: 3px;
    padding: 3px;
    background: #f0f0f0;
    color: #000000;
}
.loading {
    background:url("{{ STATIC_URL}}images/ajax-loader.gif") no-repeat scroll right center;
    padding-right: 10px;
}
.loading-topleft {
    background:url("{{ STATIC_URL}}images/ajax-loader.gif") no-repeat scroll left top;
}
</style>

<div id="" class="eval" style="padding-bottom: 5px;">
    <h3>Evaluation (click to edit)</h3>

    {% for c in application.session.evaluationcriterion_set.all %}
    	{% with c.id as cid %}
        	<input type="text" style="width: 50px;" value="{% for k, v in evaluation.criteria.items %}{% ifequal k cid %}{{v}}{% endifequal %}{% endfor %}" id="criteria_{{ cid }}" />&nbsp;&nbsp;
        {% endwith %}
        <label>{{ c.criteria }}</label><br/>
    {% endfor %}
</div>

<div id="" class="leftpanel">
    <div style="float: left; width: 125px; height: 125px;">
    	<a href="{% avatar_url application.profile.user2 500 %}" id="avatar">
        	{% avatar application.profile.user2 110 %}
        </a>
    </div>

	<div style="height: 125px;">
    	<h2>{{ application.profile.first_name }} {{ application.profile.first_name }}</h2>
    	<h3>{{ application.session.name }}</h3>

    	<p>Application created: {{ application.created|date }}<br/>
    	Application modified: {{ application.updated|date }}</p>
    </div>
    <div style="height: 2em;"></div>
</div>

<div id="eval-tabs" style="clear: both; position: relative; border-top: 1px solid;">
	<ul style="width: 50%; position: absolute; top: -2.7em;">
		<li><a href="#info">General Info</a></li>
		<li><a href="#questions">Questions</a></li>
		<li><a href="#interview">Interview</a></li>
		<li><a href="#notes">Notes</a></li>
		<li><a href="#summary">Summary</a></li>
	</ul>

    <div id="info">
        <div class="eval">
            <textarea name="language">{% for k, c in evaluation.comments.items %}{% ifequal k "language" %}{{c}}{% endifequal %}{% endfor %}</textarea>
        </div>

        <div class="leftpanel">
            <strong style="width: 10em;">English language</strong>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Reading: {{ application.en_reading }}
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Writing: {{ application.en_writing }}
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Speaking: {{ application.en_speaking }}
            <br/>
            
            <strong>French language</strong>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Reading: {{ application.fr_reading }}
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Writing: {{ application.fr_writing }}
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Speaking: {{ application.fr_speaking }}
            <br/>
            
            <strong>GPA</strong>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            {{ application.gpa }}
        </div>
        
        <hr class="clear"/>

        <div class="eval">
            <h3>&nbsp;</h3>
            <textarea name="schooling">{% for k, c in evaluation.comments.items %}{% ifequal k "schooling" %}{{c}}{% endifequal %}{% endfor %}</textarea>
        </div>

        <div class="leftpanel">
            <h3>Schooling</h3>
            <div class="htmlbox">
                {{ application.schooling|safe }}
            </div>
        </div>

        <hr class="clear"/>

        <div class="eval">
            <h3>&nbsp;</h3>
            <textarea name="resume">{% for k, c in evaluation.comments.items %}{% ifequal k "resume" %}{{c}}{% endifequal %}{% endfor %}</textarea>
        </div>

        <div class="leftpanel">
            <h3>Resume</h3>
            <div class="htmlbox">
                {{ application.resume_text|safe }}
            </div>
        </div>

        <hr class="clear"/>

        <div class="eval">
            <h3>&nbsp;</h3>
            <textarea name="references">{% for k, c in evaluation.comments.items %}{% ifequal k "references" %}{{c}}{% endifequal %}{% endfor %}</textarea>
        </div>

        <div class="leftpanel">
            <h3>References</h3>
            <div class="htmlbox">
                {{ application.references|safe }}
            </div>
        </div>
    </div>
    
    <div id="questions">
        {% for q in application.session.question_set.all %}
            <div class="eval">
                <h3>&nbsp;</h3>
                <textarea name="{{q.id}}">{% for k, c in evaluation.comments.items %}{% ifequal k q.strid %}{{c}}{% endifequal %}{% endfor %}</textarea>
            </div>

            <div class="leftpanel">
                <h3>{{ q.question }}</h3>
                <div class="htmlbox">
                    {% for qid, ans in application.get_answers.items %}
                        {% ifequal q.id qid %}
                            {{ans|safe}}
                        {% endifequal %}
                    {% endfor %}
                </div>
            </div>

            <hr class="clear"/>

        {% endfor %}
    </div>
    
    <div id="interview">
    	what goes here, if anything?
    </div>
    
    <div id="notes">
        <div class="eval" style="width: 100%;">
        	<strong>General notes</strong> (click to edit):<br/>
            <textarea name="notes" id="notes">{% for k, c in evaluation.comments.items %}{% ifequal k "notes" %}{{c}}{% endifequal %}{% endfor %}</textarea>
        </div>
    </div>
    
    <div id="summary">
    	<div id="summary-content">
    	</div>
    </div>
    
</div>

{% endblock %}

{% block extra_body %}
<script type="text/javascript" src="{{STATIC_URL}}js/autoresize.jquery.min.js"></script>
<script type="text/javascript">
	$().ready(function() {
		$("#eval-tabs").tabs({
			show: function(event, ui) {
				// ajax-load the summary tab when selected
				if (ui.panel.id == 'summary')
				{
					$('#summary-content').addClass('loading-topleft');
					$.getJSON('{% url evaluation_comment evaluation.id %}',
							function(data) {
								var html = "";
								for (k in data)
								{
									html = html + "<p>";
									html = html + data[k]['fields']['comment']
									html = html + "</p>";
								}
								$('#summary-content').removeClass('loading-topleft');
								$('#summary-content').html(html);
							});
				}
			}
		});

		// set proper URL handlers for all the criteria elements
	    {% for c in application.session.evaluationcriterion_set.all %}
	    	$('#criteria_{{ c.id }}').data('url', '{% url evaluation_criteria application.id c.id %}');
		{% endfor %}
		
		// replace <input type=text> with labels, and handle in-place editing
    	$('.eval input[type=text]').addClass('inputbox');
		$('.eval input[type=text]').click(function() {
			var original_text = $(this).val();
	        $(this).removeClass('inputbox');
		    $(this).blur(function() {
		        var myself = $(this);
		        var criteria_id = $(this).attr('id').substr(9);
		        if (original_text != myself.val())
		        {
	    	        myself.addClass('loading');
    	        	$.post($(this).data('url'),
    	               	  {'value': myself.val()},
    	               	  function(data) {
            	            myself.removeClass('loading');
        	               	if (data != "invalid")
        	               	{
	            	            myself.val(data);
	            	            myself.addClass('inputbox');
        	               	}
               	            myself.unbind('blur');
            	       	  });
		        }
		        else
			    	myself.addClass('inputbox');
		    });
    	});

		// replace <textarea> with labels, and handle in-place editing		
    	$('.eval textarea').addClass('inputbox').autoResize().trigger('change');
    	$('.eval textarea').click(function() {
		    var original_text = $(this).val();
	        $(this).removeClass('inputbox');
		    $(this).blur(function() {
		        var myself = $(this);
		        if (original_text != myself.val())
		        {
        	        myself.addClass('loading');
        	        $.post('{% url evaluation_comment application.id %}',
        	               {'key': myself.attr('name'),
        	                'comment': myself.val()},
        	               function(data) {
                	            myself.removeClass('loading');
                	            myself.addClass('inputbox');
                	            myself.unbind('blur');
                	       });
                }
                else
                    myself.addClass('inputbox');
		    });
    	});
	});
		
</script>
{% endblock %}
